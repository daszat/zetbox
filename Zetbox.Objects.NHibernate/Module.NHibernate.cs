// <autogenerated/>

namespace Zetbox.Objects
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using System.Threading;
    using Autofac;
	using Zetbox.API;
    using global::NHibernate;
    using global::NHibernate.Cfg;
    using Zetbox.API.Configuration;
    using Zetbox.API.Utils;
    using Zetbox.App.Extensions;
    using Zetbox.DalProvider.Base;
    using Zetbox.DalProvider.NHibernate;

    public class NHibernateModule
        : Autofac.Module
    {
        protected override void Load(ContainerBuilder builder)
        {
            base.Load(builder);


            builder
                .Register<NHibernateImplementationTypeChecker>(
                    c => new NHibernateImplementationTypeChecker(
                        c.Resolve<Func<IEnumerable<IImplementationTypeChecker>>>()))
                .As<INHibernateImplementationTypeChecker>()
                .As<IImplementationTypeChecker>()
                .InstancePerDependency();
                
            builder
                .Register<NHibernateActionsManager>(
                    c => new NHibernateActionsManager(
                        c.Resolve<ILifetimeScope>(),
                        c.Resolve<IEnumerable<ImplementorAssembly>>()))
                .As<INHibernateActionsManager>()
                .InstancePerLifetimeScope();

            builder
                .Register<ISessionFactory>(
                    c => {
                        var zetboxConfig = c.Resolve<ZetboxConfig>();
                        using (Logging.Log.InfoTraceMethodCall("Init NH Session Factory"))
                        {
                            var result = new Configuration();
                            var connectionString = zetboxConfig.Server.GetConnectionString(Zetbox.API.Helper.ZetboxConnectionStringKey);
                            result.Properties["dialect"] = connectionString.DatabaseProvider;
                            result.Properties["connection.connection_string"] = connectionString.ConnectionString;
                            result.Properties["max_fetch_depth"] = "1"; // keep SQL statements small

                            return result
                                .AddAssembly(typeof(NHibernateModule).Assembly)
                                .BuildSessionFactory();
                        }
                    })
                .SingleInstance();
        }
    }


    internal sealed class NHibernateImplementationTypeChecker
        : Zetbox.API.BaseImplementationTypeChecker, INHibernateImplementationTypeChecker
    {
        public NHibernateImplementationTypeChecker(Func<IEnumerable<IImplementationTypeChecker>> implTypeCheckersFactory)
            : base(implTypeCheckersFactory)
        {
        }

        protected override System.Reflection.Assembly GetAssembly()
        {
            return typeof(NHibernateImplementationTypeChecker).Assembly;
        }
    }

    // marker class to provide stable and correct assembly reference
    internal sealed class NHibernateActionsManager
        : BaseCustomActionsManager, INHibernateActionsManager
    {
        private static readonly SemaphoreSlim _initLock = new SemaphoreSlim(1, 1);
        private static bool _isInitialised = false;

        protected override SemaphoreSlim InitLock => _initLock;
        protected override bool IsInitialised
        {
            get { return _isInitialised; }
            set { _isInitialised = value; }
        }

        public NHibernateActionsManager(ILifetimeScope container, IEnumerable<ImplementorAssembly> assemblies)
            : base(container, "NHibernateImpl", assemblies)
        {
        }
    }
}
